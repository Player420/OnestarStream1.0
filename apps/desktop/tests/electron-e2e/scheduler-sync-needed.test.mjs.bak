/**
 * scheduler-sync-needed.test.mjs
 * 
 * Tests "needs-sync" state display
 * 
 * Validates:
 * - Health report with warnings displays correctly
 * - Critical warnings highlighted
 * - Recommendations shown
 */

import { navigate, waitForSelector, clickElement, waitForText, getElementText } from './helpers/waitForSelector.js';
import { forceSyncStatus } from './helpers/ipc.js';

/**
 * Test: Needs-sync state UI display
 * 
 * @param {Object} context - { electronProcess, cdpClient, close }
 */
export default async function test({ cdpClient }) {
  console.log('[Test] Navigating to settings page...');

  // Step 1: Navigate to /settings/sync
  await navigate(cdpClient, 'http://localhost:3000/settings/sync');
  await waitForSelector(cdpClient, 'main', { timeout: 10000 });
  console.log('[Test] Settings page loaded');

  // Step 2: Click "Scheduler" tab
  console.log('[Test] Clicking Scheduler tab...');
  await clickElement(cdpClient, 'button:has-text("Scheduler")');
  await waitForSelector(cdpClient, '.status-card, [data-testid="status-card"]', { timeout: 5000 });
  console.log('[Test] Scheduler tab active');

  // Step 3: Emit health report with critical warnings
  console.log('[Test] Emitting health report with critical warnings...');
  const criticalHealthReport = {
    needsSync: true,
    isAligned: false,
    warnings: [
      {
        severity: 'critical',
        message: 'Keystore missing 15 owner keys',
        recommendation: 'Import latest keystore backup'
      },
      {
        severity: 'warning',
        message: 'Last sync 48 hours ago',
        recommendation: 'Run manual sync check'
      },
      {
        severity: 'info',
        message: 'Vault password not rotated in 90 days',
        recommendation: 'Consider password rotation'
      }
    ],
    lastCheck: Date.now() - 172800000, // 48h ago
    nextScheduled: Date.now() + 3600000
  };

  await forceSyncStatus(cdpClient, criticalHealthReport);
  console.log('[Test] Health report emitted');

  // Step 4: Verify "Needs Sync" status
  console.log('[Test] Verifying needs-sync status display...');
  await waitForText(cdpClient, 'main', /needs.sync|Needs Sync/i, { timeout: 5000 });
  console.log('[Test] ✅ Needs-sync status displayed');

  // Step 5: Verify warnings are displayed
  console.log('[Test] Checking for warning display...');
  
  // Should find critical warning
  const hasCriticalWarning = await waitForText(
    cdpClient,
    'main',
    /missing.15.owner.keys|Keystore missing/i,
    { timeout: 3000 }
  ).then(() => true).catch(() => false);

  if (!hasCriticalWarning) {
    throw new Error('Critical warning not displayed in UI');
  }
  console.log('[Test] ✅ Critical warning displayed');

  // Should find warning severity
  const hasWarningLevel = await waitForText(
    cdpClient,
    'main',
    /Last.sync.48.hours/i,
    { timeout: 3000 }
  ).then(() => true).catch(() => false);

  if (!hasWarningLevel) {
    throw new Error('Warning-level message not displayed in UI');
  }
  console.log('[Test] ✅ Warning-level message displayed');

  // Step 6: Verify recommendations are shown
  console.log('[Test] Checking for recommendations...');
  
  const hasRecommendation = await waitForText(
    cdpClient,
    'main',
    /import.*keystore.*backup|recommendation/i,
    { timeout: 3000 }
  ).then(() => true).catch(() => false);

  if (!hasRecommendation) {
    console.warn('[Test] Recommendation not found in UI');
  } else {
    console.log('[Test] ✅ Recommendation displayed');
  }

  // Step 7: Verify warning count badge (if present)
  console.log('[Test] Checking warning count...');
  
  // NavBar badge should show warning indicator
  const badgeSelector = 'nav a[href="/settings/sync"] span';
  const badgeText = await getElementText(cdpClient, badgeSelector);
  
  if (badgeText !== '!') {
    console.warn(`[Test] Badge text is "${badgeText}", expected "!" for needs-sync`);
  } else {
    console.log('[Test] ✅ Badge shows alert indicator');
  }

  // Step 8: Test warning severity filtering (if UI supports it)
  console.log('[Test] Verifying all 3 warnings present...');
  
  const pageText = await getElementText(cdpClient, 'main');
  const warningCount = (pageText.match(/severity|warning|critical/gi) || []).length;
  
  if (warningCount < 3) {
    console.warn(`[Test] Expected 3 warnings, text mentions ${warningCount} occurrences`);
  } else {
    console.log(`[Test] ✅ Found ${warningCount} warning-related terms`);
  }

  // Step 9: Verify lastCheck timestamp
  console.log('[Test] Checking last check timestamp...');
  
  const hasTimestamp = await waitForText(
    cdpClient,
    'main',
    /48.hours|2.days|Last (check|sync)/i,
    { timeout: 3000 }
  ).then(() => true).catch(() => false);

  if (!hasTimestamp) {
    console.warn('[Test] Last check timestamp not found');
  } else {
    console.log('[Test] ✅ Last check timestamp displayed');
  }

  // Step 10: Clear warnings by emitting up-to-date report
  console.log('[Test] Clearing warnings...');
  const cleanHealthReport = {
    needsSync: false,
    isAligned: true,
    warnings: [],
    lastCheck: Date.now(),
    nextScheduled: Date.now() + 3600000
  };

  await forceSyncStatus(cdpClient, cleanHealthReport);

  // Step 11: Verify warnings cleared
  await waitForText(cdpClient, 'main', /up.to.date|Up to Date/i, { timeout: 5000 });
  console.log('[Test] ✅ Warnings cleared, status up-to-date');

  // Verify no warnings displayed
  const stillHasWarnings = await waitForText(
    cdpClient,
    'main',
    /missing.15.owner.keys/i,
    { timeout: 2000 }
  ).then(() => true).catch(() => false);

  if (stillHasWarnings) {
    console.warn('[Test] Warnings still displayed after clearing');
  } else {
    console.log('[Test] ✅ Warnings removed from UI');
  }

  console.log('[Test] ✅ All needs-sync display tests passed');
}
