/**
 * scheduler-status-event.test.mjs
 * 
 * Tests IPC event flow: main → preload → renderer
 * 
 * Validates:
 * - forceSyncStatus() emits IPC event
 * - BackgroundSyncProvider receives event
 * - UI updates (status card, badge color)
 */

import { navigate, waitForSelector, clickElement, waitForText, getElementAttribute, getElementText } from './helpers/waitForSelector.js';
import { forceSyncStatus, getSyncContextState } from './helpers/ipc.js';

/**
 * Test: IPC event propagates to UI
 * 
 * @param {Object} context - { electronProcess, cdpClient, close }
 */
export default async function test({ cdpClient }) {
  console.log('[Test] Navigating to settings page...');

  // Step 1: Navigate to /settings/sync
  await navigate(cdpClient, 'http://localhost:3000/settings/sync');
  await waitForSelector(cdpClient, 'main', { timeout: 10000 });
  console.log('[Test] Settings page loaded');

  // Step 2: Click "Scheduler" tab
  console.log('[Test] Clicking Scheduler tab...');
  const schedulerTabSelector = 'button:has-text("Scheduler")';
  await clickElement(cdpClient, schedulerTabSelector);
  
  // Wait for tab content to render
  await waitForSelector(cdpClient, '.status-card, [data-testid="status-card"]', { timeout: 5000 });
  console.log('[Test] Scheduler tab active');

  // Step 3: Emit fake IPC event (needs-sync state)
  console.log('[Test] Emitting test IPC event: needs-sync');
  const testHealthReport = {
    needsSync: true,
    isAligned: false,
    warnings: [
      {
        severity: 'critical',
        message: 'Test warning: keystore out of sync',
        recommendation: 'Run manual import'
      }
    ],
    lastCheck: Date.now(),
    nextScheduled: Date.now() + 3600000
  };

  await forceSyncStatus(cdpClient, testHealthReport);
  console.log('[Test] IPC event emitted');

  // Step 4: Wait for UI to update (status card should show "Needs Sync")
  console.log('[Test] Waiting for UI to reflect needs-sync state...');
  await waitForText(cdpClient, 'main', /needs.sync|Needs Sync/i, { timeout: 5000 });
  console.log('[Test] ✅ Status card updated');

  // Step 5: Verify badge color changed to red
  console.log('[Test] Checking NavBar badge color...');
  const badgeSelector = 'nav a[href="/settings/sync"] span';
  
  // Badge text should be "!" (needs-sync indicator)
  const badgeText = await getElementText(cdpClient, badgeSelector);
  if (badgeText !== '!') {
    console.warn(`[Test] Badge text is "${badgeText}", expected "!" for needs-sync state`);
  } else {
    console.log('[Test] ✅ Badge text is correct: "!"');
  }

  // Badge color should be red (#ef4444)
  const badgeStyle = await getElementAttribute(cdpClient, badgeSelector, 'style');
  const hasRedColor = 
    badgeStyle.includes('#ef4444') || 
    badgeStyle.includes('rgb(239, 68, 68)');
  
  if (!hasRedColor) {
    console.warn(`[Test] Badge style may not be red: ${badgeStyle}`);
  } else {
    console.log('[Test] ✅ Badge color is red');
  }

  // Step 6: Verify warning is displayed
  console.log('[Test] Checking for warning display...');
  const hasWarning = await waitForText(
    cdpClient, 
    'main', 
    /keystore.out.of.sync|Test warning/i,
    { timeout: 3000 }
  ).then(() => true).catch(() => false);

  if (!hasWarning) {
    console.warn('[Test] Warning message not found in UI');
  } else {
    console.log('[Test] ✅ Warning displayed');
  }

  // Step 7: Emit up-to-date event
  console.log('[Test] Emitting up-to-date IPC event...');
  const upToDateReport = {
    needsSync: false,
    isAligned: true,
    warnings: [],
    lastCheck: Date.now(),
    nextScheduled: Date.now() + 3600000
  };

  await forceSyncStatus(cdpClient, upToDateReport);

  // Step 8: Wait for UI to update (status should show "Up to Date")
  console.log('[Test] Waiting for UI to reflect up-to-date state...');
  await waitForText(cdpClient, 'main', /up.to.date|Up to Date/i, { timeout: 5000 });
  console.log('[Test] ✅ Status card updated to up-to-date');

  // Step 9: Verify badge color changed to green
  const finalBadgeText = await getElementText(cdpClient, badgeSelector);
  if (finalBadgeText !== '✓') {
    console.warn(`[Test] Badge text is "${finalBadgeText}", expected "✓" for up-to-date state`);
  } else {
    console.log('[Test] ✅ Badge text is correct: "✓"');
  }

  const finalBadgeStyle = await getElementAttribute(cdpClient, badgeSelector, 'style');
  const hasGreenColor = 
    finalBadgeStyle.includes('#10b981') || 
    finalBadgeStyle.includes('rgb(16, 185, 129)');
  
  if (!hasGreenColor) {
    console.warn(`[Test] Badge style may not be green: ${finalBadgeStyle}`);
  } else {
    console.log('[Test] ✅ Badge color is green');
  }

  console.log('[Test] ✅ All IPC event tests passed');
}
